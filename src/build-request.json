{
  "kind": "build_request",
  "title": "Fix admin Principal registration and authorization system",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Modify the backend to automatically register the first authenticated user's Principal as an admin when no admins exist in the system",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-latest"
        ],
        "quotes": [
          "Failed to update shop name: Unauthorized: Only admins can set shop branding",
          "WHO IS ADMIN"
        ]
      },
      "acceptanceCriteria": [
        "When the admin list is empty, the first user to authenticate is automatically added as an admin",
        "Subsequent users are not automatically granted admin access",
        "The automatic registration persists across canister upgrades"
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure the isAdmin check in the backend properly validates the caller's Principal against the adminPrincipals set before allowing shop branding operations",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-latest"
        ],
        "quotes": [
          "Failed to update shop name: Unauthorized: Only admins can set shop branding"
        ]
      },
      "acceptanceCriteria": [
        "setBranding function correctly rejects non-admin users with 'Unauthorized' error",
        "setBranding function allows admin users to update shop name and logo",
        "The admin check uses the correct Principal comparison logic"
      ]
    },
    {
      "id": "REQ-3",
      "text": "Add debug logging in the backend to trace Principal authentication flow and admin authorization checks for troubleshooting",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-latest"
        ]
      },
      "acceptanceCriteria": [
        "Log the caller's Principal when they authenticate",
        "Log the list of admin Principals when authorization is checked",
        "Log the result of the isAdmin check (true/false)"
      ]
    }
  ],
  "constraints": [
    "Preserve the existing adminPrincipals HashSet structure in the backend",
    "Maintain compatibility with the existing addAdminPrincipal and removeAdminPrincipal functions",
    "Do not modify frontend authentication or admin management UI components"
  ],
  "nonGoals": [
    "Changing the Internet Identity authentication flow",
    "Modifying the frontend admin management UI",
    "Adding password-based authentication",
    "Creating a separate super-admin role"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}